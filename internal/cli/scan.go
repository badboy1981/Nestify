package cli

import (
	"encoding/json"
	"flag"
	"fmt"
	"os"
	"path/filepath"
	"time"

	"github.com/badboy1981/Nestify/internal/pathutil"
	"github.com/badboy1981/Nestify/internal/scanner"
	"github.com/badboy1981/Nestify/internal/treeprinter"
	"github.com/badboy1981/Nestify/internal/types"
)

// Ø¨Ø®Ø´ ØªØºÛŒÛŒØ± ÛŒØ§ÙØªÙ‡ Ø¯Ø± ØªØ§Ø¨Ø¹ runScanCmd
func runScanCmd() {
	cmd := flag.NewFlagSet("scan", flag.ExitOnError)
	path := cmd.String("path", ".", "Project path to scan")
	tree := cmd.Bool("tree", false, "Generate tree-view report")
	foldersOnly := cmd.Bool("folders-only", false, "Scan folders only")

	cmd.Parse(os.Args[2:])

	// Ø§Ø³ØªÙØ§Ø¯Ù‡ ØµØ­ÛŒØ­ Ø§Ø² Ù¾Ú©ÛŒØ¬ Ø¬Ø¯ÛŒØ¯
	cleanPath := pathutil.NormalizeForOS(*path)
	runScan(cleanPath, *tree, *foldersOnly)
}

func runScan(cleanPath string, printTree bool, foldersOnly bool) {
	rootNodes, err := scanner.Scan(cleanPath, foldersOnly)
	if err != nil {
		fmt.Printf("âŒ Scan error: %v\n", err)
		return
	}

	// Û±. Ø¨Ù‡ Ø¯Ø³Øª Ø¢ÙˆØ±Ø¯Ù† Ù†Ø§Ù… ÙˆØ§Ù‚Ø¹ÛŒ Ù¾ÙˆØ´Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡ Ø¨Ù‡ Ø¬Ø§ÛŒ "."
	absPath, _ := filepath.Abs(cleanPath)
	projectName := filepath.Base(absPath)

	// Ø§Ú¯Ø± Ø¨Ù‡ Ù‡Ø± Ø¯Ù„ÛŒÙ„ÛŒ Ù†Ø§Ù… Ø®Ø§Ù„ÛŒ Ø¨ÙˆØ¯ ÛŒØ§ Ø±ÛŒØ´Ù‡ Ø¯Ø±Ø§ÛŒÙˆ Ø¨ÙˆØ¯
	if projectName == "" || projectName == "." || projectName == "/" || projectName == "\\" {
		projectName = "project"
	}

	// Û². Ø§ØµÙ„Ø§Ø­ Ù†Ø§Ù… Ù†ÙˆØ¯ Ø±ÛŒØ´Ù‡ Ø¯Ø± Ø®Ø±ÙˆØ¬ÛŒ (Ø¨Ø³ÛŒØ§Ø± Ù…Ù‡Ù…)
	// Ø§Ø³Ú©Ù†Ø± Ù…Ø¹Ù…ÙˆÙ„Ø§Ù‹ ÛŒÚ© Ù†ÙˆØ¯ Ø±ÛŒØ´Ù‡ Ø¨Ø±Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø§Ù†Ø¯ Ú©Ù‡ Ù†Ø§Ù…Ø´ "." Ø§Ø³Øª.
	if len(rootNodes) > 0 && rootNodes[0].Name == "." {
		rootNodes[0].Name = projectName
	}

	// Û³. Ù…Ø¯ÛŒØ±ÛŒØª Ù¾ÙˆØ´Ù‡ Ú¯Ø²Ø§Ø±Ø´Ø§Øª
	reportDir := pathutil.NormalizeForOS("reports")
	if err := os.MkdirAll(reportDir, 0755); err != nil {
		fmt.Printf("âŒ Error creating report directory: %v\n", err)
		return
	}

	// Û³. Ù†Ø§Ù…â€ŒÚ¯Ø°Ø§Ø±ÛŒ Ø¨Ø§ Ø²Ù…Ø§Ù† Ø¯Ù‚ÛŒÙ‚
	timestamp := time.Now().Format("20060102_150405")
	baseFileName := fmt.Sprintf("%s_%s", projectName, timestamp)

	jsonPath := filepath.Join(reportDir, baseFileName+".json")
	mdPath := filepath.Join(reportDir, baseFileName+".md")

	// Ø°Ø®ÛŒØ±Ù‡ JSON
	if err := saveJSON(rootNodes, jsonPath); err != nil {
		fmt.Printf("âŒ JSON save error: %v\n", err)
	}

	// Ø°Ø®ÛŒØ±Ù‡ Markdown (ÙÙ‚Ø· Ø§Ú¯Ø± ÙÙ„Ú¯ tree-- Ø²Ø¯Ù‡ Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯)
	if printTree {
		if err := saveTree(rootNodes, mdPath, projectName); err != nil {
			fmt.Printf("âŒ Markdown save error: %v\n", err)
		}
	}

	fmt.Println("\nâœ… Scan completed successfully!")
	fmt.Printf("ğŸ“‚ Reports saved in: %s\n", reportDir)
	fmt.Printf("   ğŸ“„ JSON: %s\n", filepath.Base(jsonPath))
	if printTree {
		fmt.Printf("   ğŸ“„ Markdown: %s\n", filepath.Base(mdPath))
	}
}

// ØªØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ JSON
func saveJSON(data interface{}, targetPath string) error {
	file, err := json.MarshalIndent(data, "", "  ")
	if err != nil {
		return err
	}
	return os.WriteFile(targetPath, file, 0644)
}

// ØªØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø³Ø§Ø®ØªØ§Ø± Ø¯Ø±Ø®ØªÛŒ Ø¯Ø± ÙØ§ÛŒÙ„ Markdown
func saveTree(nodes []types.Node, targetPath string, projectName string) error {
	content := fmt.Sprintf("# Project Structure: %s\n\n", projectName)
	content += "Generated by **Nestify** on " + time.Now().Format("2006-01-02 15:04:05") + "\n\n"
	content += "```text\n"

	// Ø§ØµÙ„Ø§Ø­ Ø§ÛŒÙ† Ø¨Ø®Ø´: Ù¾ÛŒÙ…Ø§ÛŒØ´ Ø±ÙˆÛŒ Ù†ÙˆØ¯Ù‡Ø§ÛŒ Ø±ÛŒØ´Ù‡ Ùˆ ØªØ¨Ø¯ÛŒÙ„ Ø¢Ù†â€ŒÙ‡Ø§ Ø¨Ù‡ Ø±Ø´ØªÙ‡
	for _, node := range nodes {
		content += treeprinter.GetTreeString(&node)
	}

	content += "```\n"

	return os.WriteFile(targetPath, []byte(content), 0644)
}
